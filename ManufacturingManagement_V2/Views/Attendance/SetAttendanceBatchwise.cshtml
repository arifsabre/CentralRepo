@model ManufacturingManagement_V2.Models.AttendanceBatchMdl
@using Newtonsoft.Json
@{
    ViewBag.Title = "Index";
    Layout = "~/views/shared/_LayoutCommon.cshtml";
}

<h4><b>Attendance List</b></h4>

<p>
    @Html.ActionLink("Generate Attendance", "GenerateAttendance", null, new{ @class = "btn btn-default"})
</p>
    @Html.HiddenFor(model => model.AttYear)
    @Html.HiddenFor(model => model.AttMonth)
    @Html.HiddenFor(model => model.AttShift)
    @Html.HiddenFor(model => model.AttDay)
<p style="font-size:16px;font-weight:bold;">
    Unit: @Html.DisplayFor(model => model.UnitName), Grade: @Html.DisplayFor(model => model.GradeName)<br/>
    Attendance For: @Html.DisplayFor(model => model.MonthName) @Html.DisplayFor(model => model.AttDay), @Html.DisplayFor(model => model.AttYear) - @Html.DisplayFor(model => model.ShiftName) Shift <br/>
</p>
@Html.ActionLink("Back", null,null,new{@onclick="window.close()"})
<table id="StepsTable" class="tablecontainer" style="width:100%;">
    <tr>
        <th style="width:30px;">
           S.No.
        </th>
        <th style="width:50px;">
           EMP Code
        </th>
        <th>
           Employee Name
        </th>
        <th>
           Father's Name
        </th>
        <th style="width:80px;">
           Attendance
        </th>
        <th style="display:none;">
           NewEmpId
        </th>
        <th style="width:80px;">
           Remaining CL
        </th>
    </tr>
    @{int i = 1;}
    @foreach (var item in Model.EmpAttendance)
    {
    <tr>
        <td>
            <b>@i</b>
        </td>
        <td>
            @Html.Label("lblEmpId" + i.ToString(), item.EmpId, new { @id = "EmpId" + (i - 1) })
        </td>
        <td>
            @Html.Label("lblEmpName" + i.ToString(), item.EmpName)
        </td>
        <td>
            @Html.Label("lblFatherName" + i.ToString(), item.FatherName)
        </td>
        <td>
            @*@Html.DropDownListFor(model => item.AttValue, ViewBag.LeaveTypeList as SelectList)*@
            @Html.TextBox("txtAttValue" + i.ToString(), item.AttValue, new { @id = "AttValue" + (i - 1), style = "width: 100px; height: 25px; padding: 0; text-align:center;" })
        </td>
        <td style="display:none;">@Html.HiddenFor(model => item.NewEmpId)
           @Html.Label("lblNewEmpId"+i.ToString(),item.NewEmpId,new { @id = "NewEmpId" + (i-1)})
        </td>
        <td>
            @Html.Label("lblRemainingCL" + i.ToString(), item.remainingCL, new { style = "width: 50px; height: 25px; padding: 0; text-align:center;" })
        </td>
    </tr>
    i++;
}

</table>

<h5><b>@ViewBag.Message</b></h5>
        <p>
            @*<input type="submit" class="btn btn-default" value="Submit" />*@
            <input id="submit" class="btn btn-default" type="button" value="Submit" style="padding:10px 20px" />
            @Html.ActionLink("Back", null,null,new{@onclick="window.close()"})
        </p>

@section Scripts{
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script>
        $(document).ready(function () {

            $("#submit").click(function () {

                
                var empatt = [];

                //Collects the data from textboxes and adds it to the dictionary
                $("#StepsTable tr").each(function (index, item) {
                    if (index > 0)
                    {
                        var tds = $(this).find("td");
                        var empid = $(tds).eq(1).text();
                        var empname = $(tds).eq(2).text();
                        var fathername = $(tds).eq(3).text();
                        var textboxValue = $(tds).eq(4).find("input").val();
                        var newempid = $(tds).eq(5).text();
                        empatt.push({
                            NewEmpId: newempid,
                            EmpName: empname,
                            FatherName: empname,
                            AttValue: textboxValue
                        });
                    }
                });
                
                $(this).val('Please wait...');

                var data = {
                    AttYear: '@Model.AttYear',
                    AttMonth: '@Model.AttMonth',
                    AttShift: '@Model.AttShift',
                    AttDay: '@Model.AttDay',
                    EmpAttendance: empatt
                }
                
                //Makes ajax call to controller 
                $.ajax({
                    url: "/Attendance/SetAttendanceBatchwise",
                    type: "POST",
                    data: JSON.stringify(data),
                    dataType: "JSON",
                    contentType: "application/json",
                    success: function (d) {
                        //check is successfully save to database 
                        if (d.status == true) {
                            //will send status from server side
                            alert(d.message);
                            //clear form
                            empatt = [];
                            //$('#orderNo').val('');
                            //$('#orderDate').val('');
                            //$('#orderItems').empty();
                        }
                        else {
                            alert(d.message);
                        }
                        $('#submit').val('Submit');
                    },
                    error: function () {
                        alert('Error. Please try again.');
                        $('#submit').val(d.AddEdit);
                    }
                });

            });

        });
    </script>
  
}



