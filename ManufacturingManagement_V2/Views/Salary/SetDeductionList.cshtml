@model ManufacturingManagement_V2.Models.SetDeductionAmountMdl
@using Newtonsoft.Json
@{
    ViewBag.Title = "Index";
    Layout = "~/views/shared/_LayoutCommon.cshtml";
}

<h2>Deduction List</h2>
    @Html.HiddenFor(model => model.VDate)
<p style="font-size:16px;font-weight:bold;">
    Advance Outstanding as on date: @Html.DisplayFor(model => model.VDate)
    <br/>@Html.ActionLink("Back to Salary Generation", null, null, new { @onclick="window.close();" } )
</p>
<table id="StepsTable" class="tablecontainer" style="width:100%;">
    <tr>
        <th style="width:30px;">
           S.No.
        </th>
        <th style="width:50px;">
           EMP Code
        </th>
        <th style="width:auto;">
           Employee Name
        </th>
        <th style="width:100px;">
           Balance
        </th>
        <th style="width:100px;">
           Rate Of Inst.
        </th>
        <th style="width:100px;">
           Deduction Amt
        </th>
        <th style="display:none;">
           NewEmpId
        </th>
        <th style="width:auto;word-wrap:break-word;">
           Remarks
        </th>
    </tr>
    @{int i = 1;}
@foreach (var item in Model.DeductionList)
{
    <tr>
        <td>
            <b>@i</b>
        </td>
        <td>
           @Html.Label("lblEmpId"+i.ToString(),item.EmpId,new { @id = "EmpId" + (i-1)})
        </td>
        <td>
            @Html.Label("lblEmpName"+i.ToString(),item.EmpName)
        </td>
        <td>
            @Html.Label("lblBalance"+i.ToString(),item.Balance.ToString())
        </td>
        <td>
            @Html.Label("lblInstAmount"+i.ToString(),item.InstAmount.ToString())
        </td>
        <td>
            @Html.TextBox("txtDeductionAmt"+i.ToString(),item.DeductionAmt,new { @id = "DeductionAmt" + (i-1), style = "width: 100px; height: 25px; padding: 0; text-align:center;"})
        </td> 
        <td class="indexColumn" style="display:none;">@Html.HiddenFor(model => item.NewEmpId)
           @Html.Label("lblNewEmpId"+i.ToString(),item.NewEmpId.ToString(),new { @id = "NewEmpId" + (i-1)})
        </td>
        <td>
            @Html.Label("lblRemarks"+i.ToString(),item.Remarks)
        </td>
    </tr>
    i++;
}

</table>

<h5><b>@ViewBag.Message</b></h5>
        <p>
            @*<input type="submit" class="btn btn-default" value="Submit" />*@
            <input id="submit" type="button" value="Set Advance Deduction Values" 
                style="padding:10px 20px;width:280px;" />
            @Html.ActionLink("Back to Salary Generation", null, null, new { @onclick="window.close();" } )
        </p>

@section Scripts{
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script>
        $(document).ready(function () {

            $("#submit").click(function () {
                                
                var empatt = [];

                //Collects the data from textboxes and adds it to the dictionary
                $("#StepsTable tr").each(function (index, item) {
                    if (index > 0)
                    {
                        var tds = $(this).find("td");
                        var empid = $(tds).eq(1).text();
                        var empname = $(tds).eq(2).text();
                        var balance = $(tds).eq(3).text();
                        var instamt = $(tds).eq(4).text();
                        var textboxValue = $(tds).eq(5).find("input").val();
                        var newempid = $(tds).eq(6).text();
                        empatt.push({
                            EmpName: empname,
                            Balance: balance,
                            InstAmount: instamt,
                            DeductionAmt: textboxValue,
                            NewEmpId: newempid
                        });
                    }
                });
                
                $(this).val('Please wait...');

                var data = {
                    VDate: '@Model.VDate',
                    DeductionList: empatt
                }
                
                //Makes ajax call to controller 
                $.ajax({
                    url: "/Salary/SetDeductionList",
                    type: "POST",
                    data: JSON.stringify(data),
                    dataType: "JSON",
                    contentType: "application/json",
                    success: function (d) {
                        //check is successfully save to database 
                        if (d.status == true) {
                            //will send status from server side
                            alert(d.message);
                            //clear form
                            empatt = [];
                            //$('#orderNo').val('');
                            //$('#orderDate').val('');
                            //$('#orderItems').empty();
                        }
                        else {
                            alert(d.message);
                        }
                        $('#submit').val('Set Advance Deduction Values');
                    },
                    error: function () {
                        alert('Error. Please try again.');
                        $('#submit').val(d.AddEdit);
                    }
                });

            });

        });
    </script>

}


<style>
    /*Adding some css for looks good*/
    .col1 {
    width: 20px%;
}
    </style>