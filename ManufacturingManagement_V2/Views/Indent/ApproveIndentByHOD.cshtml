@model ManufacturingManagement_V2.Models.IndentLedgerMdl
@using Newtonsoft.Json
@{
    ViewBag.Title = "Index";
    Layout = "~/views/shared/_LayoutCommon.cshtml";
}

<h2>Approve Indent (HOD)</h2>

<p>
    @*@Html.ActionLink("Create Attendance Detail", "../AttendanceDetail/CreateUpdate")*@
</p>
    @Html.HiddenFor(model => model.IndentId)
<p style="font-size:16px;font-weight:bold;">
    Indent No: @Html.DisplayFor(model => model.StrIndentNo), Prepared By: @Html.DisplayFor(model => model.IndentByName), Date: @Html.ValueFor(model => model.VDate, "{0:dd/MM/yyyy}")
    <br/>Approx Value: @Html.ValueFor(model => model.ApproxValue, "{0:##,##,##,##,##0.00}")
</p>
@Html.ActionLink("Back to List", "IndentApprovalHOD")

<div class="container" style="max-width:640px">
        <div class="form-group">
<table border="1">
    <tr>
        <td style="vertical-align:top;font-weight:bold;">Item No</td>
        <td>
            @Html.Hidden("RecId", Model.RecId.ToString(), new { @id = "hfRecId" })
            @Html.Label("lblItemSlNo",Model.ItemSlNo.ToString(),new { @id = "ItemSlNo"})
        </td>
    </tr>
    <tr>
        <td style="vertical-align:top;font-weight:bold;">Item Code</td>
        <td>
            @Html.Label("lblItemCode",Model.ItemCode.ToString(),new { @id = "ItemCode"})
        </td>
    </tr>
    <tr>
        <td style="vertical-align:top;font-weight:bold;">Item Description</td>
        <td>
            @Html.Label("lblItemDesc",Model.ItemDesc.ToString(),new { @id = "ItemDesc"})
        </td>
    </tr>
    <tr style="vertical-align:top;font-weight:bold;">
        <td>Reason</td>
        <td>
            @Html.Label("lblRemarks",Model.Remarks.ToString(),new { @id = "Remarks"})
        </td>
    </tr>
    <tr>
        <td style="vertical-align:top;font-weight:bold;">Unit</td>
        <td>
            @Html.Label("lblUnitName",Model.UnitName.ToString(),new { @id = "UnitName"})
        </td>
    </tr>
    <tr>
        <td style="vertical-align:top;font-weight:bold;">Approx Rate</td>
        <td>
            @Html.TextBox("txtApproxRate",Model.ApproxRate.ToString(),new { @id = "ApproxRate" })  @* style = "width: 100px; height: 25px; padding: 0; text-align:left;"*@
        </td>
    </tr>
    <tr>
        <td style="vertical-align:top;font-weight:bold;">Indent Qty</td>
        <td>
            @Html.Label("lblIndQty",Model.IndQty.ToString(),new { @id = "IndQty"})
        </td>
    </tr>
    <tr>
        <td style="vertical-align:top;font-weight:bold;">Approved Qty</td>
        <td>
            @Html.TextBox("txtAppQty",Model.AppQty.ToString(),new { @id = "AppQty" })  @* style = "width: 100px; height: 25px; padding: 0; text-align:left;"*@
        </td>
    </tr>
    <tr>
        <td style="vertical-align:top;font-weight:bold;">Expected Date</td>
        <td>
            @Html.TextBox("txtExpectedDT",Model.ExpectedDT.ToString(),new { @id = "ExpectedDT" })
        </td>
    </tr> 
    <tr>@*@Html.Hidden("hfAdminUserId", null, new { @id = "hfAdminUserId" })*@
        <td style="vertical-align:top;font-weight:bold;">Admin Approval By:</td>
        <td>@Html.DropDownList("ddlAdminUser", ViewBag.AdminUserList as SelectList)</td>
    </tr>
    <tr>
        <td style="vertical-align:top;width:110px;font-weight:bold;">Query By Admin:</td>
        <td style="vertical-align:top;"><label id="lblAdminQuery"></label ></td>
    </tr>
    <tr>
        <td style="vertical-align:top;font-weight:bold;">Reply To Admin:</td>
        <td><input type="text" id="txtHODReply" maxlength="250" />
            <span class="error">Reply not entered!</span>
        </td>
    </tr>
    <tr>
        <td style="vertical-align:top;font-weight:bold;">Remarks&nbsp;for&nbsp;Indentor:</td>
        <td><input type="text" id="txtHODRemarks" maxlength="250" />
            <span class="error">Remarks not entered!</span>
        </td>
    </tr>
    <tr>
        <td style="vertical-align:top;font-weight:bold;">Reply from Indentor:</td>
        <td style="vertical-align:top;"><label id="lblIndentorReply"></label ></td>
    </tr>
</table>
</div>
</div>

<h5><b>@ViewBag.Message</b></h5>
        <p>
            @*<input type="submit" class="btn btn-default" value="Submit" />*@
            <input id="submit" type="button" value="Approve" style="padding:10px 20px" />
            <input id="cancel" type="button" value="Cancel" style="padding:10px 20px" />
            <input id="reply" type="button" value="Reply To Admin" style="padding:10px 20px;width:180px;" />
            <input id="remarks" type="button" value="Remarks for Indentor" style="padding:10px 20px;width:220px;" />
            @Html.ActionLink("Back To List", "IndentApprovalHOD", "Indent", null, new { id = "mylink" })
        </p>

<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

@section Scripts{
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script>
        $(document).ready(function () {
            //approval
            //Save button click function
            $('#submit').click(function () {
                
                var isAllValid = true;
                //validation of order
                if (!($('#AppQty').val().trim() != '' && !isNaN($('#AppQty').val().trim()))) {
                    isValidItem = false;
                    //$('#txtIndQty').siblings('span.error').css('visibility', 'visible');
                    alert('Invalid Approved Qty!');
                    $('#AppQty').focus();
                    return;
                }
                if (!($('#ExpectedDT').val().trim() != '')) {
                    isValidItem = false;
                    alert('Expedted date not entered!')
                    $('#ExpectedDT').focus();
                    return;
                }
                var liAdminUser = document.getElementById("ddlAdminUser");
                var adminUserIndex = liAdminUser.selectedIndex;
                if (adminUserIndex == -1) {
                    alert('Admin not selected!');
                    isValidItem = false;
                    return;
                }
                var adminUserId = liAdminUser.options[adminUserIndex].value;

                //Save if valid
                if (isAllValid) {
                    var data = {
                        //order fields
                        RecId: '@Model.RecId',
                        ExpectedDT: $('#ExpectedDT').val().trim(),
                        AdminUserId: parseInt(adminUserId),
                        IndQty: parseFloat(document.getElementById('IndQty').innerHTML),
                        AppQty: parseFloat($('#AppQty').val().trim()),
                        //ApproxRate: parseFloat(document.getElementById('ApproxRate').innerHTML),
                        ApproxRate: parseFloat($('#ApproxRate').val().trim())
                    }
                    $(this).val('Please wait...');
                    $.ajax({
                        url: '/Indent/ApproveIndentByHOD',
                        type: "POST",
                        data: JSON.stringify(data),
                        dataType: "JSON",
                        contentType: "application/json",
                        success: function (d) {
                            //check is successfully save to database 
                            if (d.status == true) {
                                //will send status from server side
                                alert(d.message);
                                //clear form
                                //$('#orderDate').val('');
                                window.location.href = $('#mylink').attr('href');
                            }
                            else {
                                alert(d.message);
                            }
                            $('#submit').val('Approve');
                        },
                        error: function () {
                            alert('Error. Please try again.');
                            $('#submit').val('Approve');
                        }
                    });
                }
            });
            //end-approval

            //cancel
            $("#cancel").click(function () {
                $(this).val('Please wait...');
                var data = {
                    RecId: '@Model.RecId'
                }
                //Makes ajax call to controller 
                $.ajax({
                    url: "/Indent/CancelIndent",
                    type: "POST",
                    data: JSON.stringify(data),
                    dataType: "JSON",
                    contentType: "application/json",
                    success: function (d) {
                        //check is successfully save to database 
                        if (d.status == true) {
                            //will send status from server side
                            alert(d.message);
                            //clear form
                            empatt = [];
                            //$('#orderNo').val('');
                            //$('#orderDate').val('');
                            //$('#orderItems').empty();
                            window.location.href = $('#mylink').attr('href')
                        }
                        else {
                            alert(d.message);
                        }
                        $('#cancel').val('Cancel');
                    },
                    error: function () {
                        alert('Error. Please try again.');
                        //$('#submit').val(d.AddEdit);//not applicable here
                    }
                });
            });
            //end-cancel

            //reply
            $("#reply").click(function () {
                
                isValidItem = true;

                if (!($('#txtHODReply').val().trim() != '')) {
                    isValidItem = false;
                    alert('Reply not entered!')
                    $('#txtHODReply').focus();
                    return;
                }

                $(this).val('Please wait...');

                if (isValidItem) {

                    var data = {
                        RecId: '@Model.RecId',
                        HODReply: $('#txtHODReply').val().trim()
                    }
                    //Makes ajax call to controller 
                    $.ajax({
                        url: "/Indent/ReplyIndent",
                        type: "POST",
                        data: JSON.stringify(data),
                        dataType: "JSON",
                        contentType: "application/json",
                        success: function (d) {
                            //check is successfully save to database 
                            if (d.status == true) {
                                //will send status from server side
                                alert(d.message);
                                //clear form
                                empatt = [];
                                window.location.href = $('#mylink').attr('href')
                            }
                            else {
                                alert(d.message);
                            }
                            $('#reply').val('Reply To Admin');
                        },
                        error: function () {
                            alert('Error. Please try again.');
                            //$('#submit').val(d.AddEdit);//not applicable here
                        }
                    });
                }
            });
            //end-query

            //reply
            $("#remarks").click(function () {

                isValidItem = true;

                if (!($('#txtHODRemarks').val().trim() != '')) {
                    isValidItem = false;
                    alert('Remarks not entered!')
                    $('#txtHODRemarks').focus();
                    return;
                }
                $(this).val('Please wait...');
                if (isValidItem) {

                    var data = {
                        RecId: '@Model.RecId',
                        HODRemarks: $('#txtHODRemarks').val().trim()
                    }
                    //Makes ajax call to controller 
                    $.ajax({
                        url: "/Indent/HODRemarksForIndentor",
                        type: "POST",
                        data: JSON.stringify(data),
                        dataType: "JSON",
                        contentType: "application/json",
                        success: function (d) {
                            //check is successfully save to database 
                            if (d.status == true) {
                                //will send status from server side
                                alert(d.message);
                                //clear form
                                empatt = [];
                                window.location.href = $('#mylink').attr('href')
                            }
                            else {
                                alert(d.message);
                            }
                            $('#remarks').val('Remarks for Indentor');
                        },
                        error: function () {
                            alert('Error. Please try again.');
                            //$('#submit').val(d.AddEdit);//not applicable here
                        }
                    });
                }
            });
            //end-remarks

        });
    </script>

    <script type="text/javascript">
        $("#txtAdminUserName").autocomplete({
            source: function (request, response) {
                var customer = new Array();
                var opt = 'admin';
                $.ajax({
                    async: false,
                    cache: false,
                    type: "POST",
                    url: "@(Url.Action("AutoCompleteUsersListByPermission", "HelpUtility"))",
                    data: { "term": request.term, "opt": opt },
                    success: function (data) {
                        for (var i = 0; i < data.length ; i++) {
                            customer[i] = { label: data[i].Value, Id: data[i].Key };
                        }
                    }
                });
                response(customer);
            }, minLength: 2,
            select: function (event, ui) {
                document.getElementById('hfAdminUserId').value = ui.item.Id;
            @*$.ajax({
                cache: false,
                async: false,
                type: "POST",
                url: "@(Url.Action("getItemDetail", "HelpUtility"))",
                        data: { "itemid": ui.item.Id },
                        success: function (data) {
                            $('#txtRate').val(data.purchaserate);
                            $('#ddlUnit').val(data.unit);
                            $('#txtItemDesc').val(data.itemname);
                            $('#txtIndQty').focus();
                            action = data.Action;
                        },
                        error: function (xhr, ajaxOptions, thrownError) {
                            alert('Failed to retrieve data.');
                        }
                });*@
        }
        });
</script>

    <script>
        //edit mode
        $(function () {
            var mainObject = @Html.Raw(Json.Encode(Model))
                txtHODReply.value = mainObject.HODReply;
                $('#lblAdminQuery').text(mainObject.AdminQuery);
                $('#lblIndentorReply').text(mainObject.IndentorReply);
                txtHODRemarks.value = mainObject.HODRemarks;
                ddlAdminUser.value = mainObject.AdminUserId;
            });
    </script>

}

<style>
    /*Adding some css for looks good*/
    span.error {
        display:block;
        visibility:hidden;
        color:red;
        font-size:90%;
    }
</style>